---
title: "Analysis"
output: html_document
---


```{r setup, include = FALSE}
library(tidyverse)
library(patchwork)
library(ggplot2)
library(rstatix)
library(knitr)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis", 
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
knitr::opts_chunk$set(
  fig.width = 6, 
  fig.asp = .6, 
  out.width = "90%"
)
```

```{r data, echo = FALSE, message = FALSE}

#load dataset
nyc_df = 
  read_csv(file = "./data/New_York_City_Leading_Causes_of_Death.csv") %>%
  janitor::clean_names() 

write_csv(nyc_df, "./data/New_York_City_Leading_Causes_of_Death.csv")

# remove parentheses from leading cause column

nyc_df$leading_cause = 
  gsub("\\s*\\([^\\)]+\\)","",as.character(nyc_df$leading_cause))

```

### What are the top 10 leading causes of death in NYC?

```{r plot 1, echo = FALSE, error = TRUE, message = FALSE}
nyc_df_1 = read_csv(file = "./data/nyc_clean.csv")

nyc_df_1 %>%
  group_by(leading_cause) %>%
  summarize(total_death = sum(deaths, na.rm = TRUE)) %>%
  arrange(desc(total_death)) %>%
  head(10) %>%
  mutate(leading_cause = fct_reorder(leading_cause, total_death)) %>% 
  ggplot(aes(x = leading_cause, y = total_death, fill = leading_cause)) +
  geom_col() +
  labs(title = "Top 10 leading causes of death in NYC.", 
    x = "Cause of death", 
    y = "Number of deaths") +
  theme(legend.position = "none") +
  coord_flip() 
  
  
#group_by(leading_cause) %>%
#  count() %>%
#  arrange(desc(n)) %>%
#  head(10) %>%
#  mutate(leading_cause = fct_reorder(leading_cause, n)) %>% 
#  ggplot(aes(x = leading_cause, y = n, fill = leading_cause)) +
#  geom_col() +
#  labs(title = "Top 10 leading causes of death in NYC", 
#    x = "Cause of death", 
#    y = "Number of deaths"
#  )+
#  theme(legend.position = "none")+
#  coord_flip() 

```


### How has the death rate of top 3 leading causes changed over the years in NYC?


```{r plot 2, echo = FALSE, error = TRUE, message = FALSE}

nyc_df %>%
  filter(leading_cause %in% c("Malignant Neoplasms", "All Other Causes", "Diseases of Heart")) %>%
  mutate(deaths = as.numeric(deaths)) %>%
  group_by(year, leading_cause) %>%  
  summarize(total_death = sum(deaths)) %>%
  ggplot(aes(x= year, y = total_death, color = leading_cause)) + 
  geom_line(size=1) + 
  labs(title='Top 10 leading causes of death (2007-2014)', x='Year', y='Death count')+ 
  theme(legend.text= element_text(size =8))

```


### How have the top 3 leading causes of death changed for each race in NYC?


```{r plot 3, echo = FALSE, error = TRUE, message = FALSE}

nyc_df %>%
  filter(leading_cause %in% c("Malignant Neoplasms", "All Other Causes", "Diseases of Heart")) %>%
  mutate(deaths = as.numeric(deaths)) %>%
  group_by(year, leading_cause, race_ethnicity) %>%  
  summarize(total_death = sum(deaths)) %>%
  ggplot(aes(x= year, y = total_death, color = leading_cause)) + 
  geom_line(size=1) + 
  labs(title='Top 3 leading causes of death by ethnicity (2007-2014)', x='Year', y='Death count') +
  facet_wrap(~race_ethnicity, ncol=3, scales = 'free_y')

```

### Are there gender differences in the leading causes of death in NYC?


```{r plot 4, echo = FALSE, error = TRUE, message = FALSE}

nyc_df %>%
  filter(leading_cause %in% c("Accidents Except Drug Posioning",
                              "Diabetes Mellitus", 
                              "Human Immunodeficiency Virus Disease", 
                              "Cerebrovascular Disease")) %>% 
  group_by(leading_cause, sex) %>% 
  count() %>%
  ggplot(aes(x = sex, y = n, fill = sex)) +
  geom_col() +
  labs(title='Gender differences in leading causes of death', x='Sex', y= 'Death count') +
  facet_wrap(~leading_cause)

```


### Is there any significant difference in death rates between men and women, in New York City?


```{r t test, echo = FALSE, error = TRUE, message = FALSE, warning = FALSE, comment = ""}

t_test_df = nyc_df %>%
  select(death_rate, sex) %>%
  mutate(
    death_rate = as.numeric(death_rate),
    sex = factor(sex)
  )

t.test(death_rate ~ sex, data = t_test_df)

```

p-value = 0.479 > 0.05

At 0.05 significance level, we fail to reject the null hypothesis and conclude that true mean difference in death rates between men and women is 0. Hence, we can state that there isn't any significant difference in the death rates between men and women in New York. 
        
            
### Is there any significant difference in death rates across different ethnicities, in New York City?    
       
         
```{r anova, echo = FALSE, error = TRUE, message = FALSE, warning = FALSE}
anova_df = nyc_df %>%
  select(death_rate, race_ethnicity) %>%
  mutate(
    death_rate = as.numeric(death_rate),
    race_ethnicity = recode(
      race_ethnicity, 
      "White Non-Hispanic" = "White",
      "Black Non-Hispanic" = "Black",
      "Other Race/ Ethnicity" = "Other",
      "Asian and Pacific Islander" = "Asian/PI",
      "Not Stated/Unknown" = "Unknown"
      ),
    race_ethnicity = factor(race_ethnicity)
  )

anova_test(death_rate ~ race_ethnicity, data = anova_df) %>% kable()
```
        
          
p-value = 1.83e-14 < 0.05

At 0.05 significance level, we reject the null hypothesis and conclude that there is a significant difference in death rates across different ethnicities, in New York City.


### What are the top 10 leading causes of death in the US?


```{r us plot 1, echo = FALSE, error = TRUE, message = FALSE}
nyc_df_1 = read_csv(file = "./data/nyc_clean.csv")
US_df_1 = read_csv(file = "./data/Leading_Causes_of_Death_States_Only.csv")

US_df_1_plot = 
  US_df_1 %>%
  filter(x113_cause_name != "All Causes") %>% 
  group_by(x113_cause_name) %>%
  summarize(total_death = sum(deaths)) %>%
  arrange(desc(total_death)) %>%
  mutate(x113_cause_name = fct_reorder(x113_cause_name, total_death)) %>% 
  ggplot(aes(x = x113_cause_name, y = total_death, fill = x113_cause_name)) +
  geom_col() +
  labs(title = "Top 10 Leading Causes of Death in the US", 
    x = "Cause of Death", 
    y = "Number of Deaths") +
  theme(legend.position = "none") +
  coord_flip() 

US_df_1_plot
```


### How has the death rate of top 3 leading causes changed over the years in NYC?


```{r us plot 2, echo = FALSE, error = TRUE, message = FALSE, warning = FALSE}
US_df_1_plot_1 = 
  US_df_1 %>% 
  filter(x113_cause_name == c("Diseases of heart", "Malignant neoplasms", "Cerebrovascular diseases")) %>% 
  group_by(year, x113_cause_name) %>%  
  summarize(total_death = sum(deaths)) %>%
  arrange(desc(total_death)) %>%
  mutate(x113_cause_name = fct_reorder(x113_cause_name, total_death)) %>% 
  ggplot(aes(x = year, y = total_death, color = x113_cause_name)) + 
  geom_line(size = 1) + 
  labs(title = 'Top 3 Leading Causes of Death (2000-2015)', x = 'Year', y = 'Death Count') 

US_df_1_plot_1
```


```{r us plot 3, echo = FALSE, error = TRUE, message = FALSE, warning = FALSE}
#US_df_1_plot_2 = 
#  US_df_1 %>% 
#  filter(x113_cause_name == c("Diseases of heart", "Malignant neoplasms", "Cerebrovascular diseases")) %>% 
#  group_by(x113_cause_name, state) %>%  
#  summarize(total_death = sum(deaths)) %>%
#  arrange(desc(total_death)) %>%
#  ggplot(aes(x = state, y = total_death, color = x113_cause_name)) + 
#  geom_line(size = 1) + 
#  facet_wrap(~x113_cause_name, ncol=3, scales = 'free_y') +
#  labs(title = 'Top 3 Leading Causes of Death by States', x = 'State', y = 'Death Count') 
```

