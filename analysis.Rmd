---
title: "Analysis"
output: html_document
---


```{r setup, include = FALSE}
library(tidyverse)
library(patchwork)
library(ggplot2)
library(rstatix)
library(knitr)
library(gganimate)
library(png)
library(gifski)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis", 
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
knitr::opts_chunk$set(
  fig.width = 6, 
  fig.asp = .6, 
  out.width = "90%"
)
```

```{r data, echo = FALSE, message = FALSE}

#load dataset
nyc_df = 
  read_csv(file = "./data/New_York_City_Leading_Causes_of_Death.csv") %>%
  janitor::clean_names() 

write_csv(nyc_df, "./data/New_York_City_Leading_Causes_of_Death.csv")

# remove parentheses from leading cause column

nyc_df$leading_cause = 
  gsub("\\s*\\([^\\)]+\\)","",as.character(nyc_df$leading_cause))

```

## **Top 10 Leading Causes of Death**

### What are the top 10 leading causes of death in the US?

```{r us plot 1, echo = FALSE, error = TRUE, message = FALSE}
nyc_df_1 = read_csv(file = "./data/nyc_clean.csv")
US_df_1 = read_csv(file = "./data/Leading_Causes_of_Death_States_Only.csv")

# to create ranking
US_df_2 = US_df_1 %>%
          subset(US_df_1$x113_cause_name != "All Causes") %>%
          group_by(x113_cause_name, year) %>% 
          summarise(total_death = sum(deaths)) %>% 
          arrange(desc(total_death)) %>% 
          group_by(year) %>% 
          mutate(order = min_rank(total_death) * 1.0) %>% 
          ungroup()

options(scipen=999)

#animated plot for US! 
anim_us = US_df_2 %>%
  ggplot(aes(order, group = x113_cause_name)) +
  geom_tile(aes(y = total_death / 2, height = total_death, width = 0.9, fill = x113_cause_name)) +
  theme(axis.text.y = element_blank(), axis.title.y = element_blank()) +
  scale_y_continuous(name = "Total Death Count") +
  transition_states(year, transition_length = 1, state_length = 3) +
  geom_text(aes(y = 0, label = x113_cause_name), hjust = 1) +
  coord_flip(clip = "off") +
  ggtitle("Top Causes of Death in US by Year: {closest_state}")+
  theme(legend.position = "none", 
        plot.margin = margin(1,1,1,7.5, 'cm'), 
        title = element_text(size = 9))

animate(anim_us, nframes = 100)

#original static plot we made for US 
#US_df_1_plot = 
  #US_df_1 %>%
  #filter(x113_cause_name != "All Causes") %>% 
  #group_by(x113_cause_name) %>%
  #summarize(total_death = sum(deaths)) %>%
  #arrange(desc(total_death)) %>%
  #mutate(x113_cause_name = fct_reorder(x113_cause_name, total_death)) %>% 
  #ggplot(aes(x = x113_cause_name, y = total_death, fill = x113_cause_name)) +
  #geom_col() +
  #labs(title = "Top 10 Leading Causes of Death in the U.S.", 
    #x = "Cause of Death", 
    #y = "Number of Deaths") +
  #theme(legend.position = "none") +
  #coord_flip() 

```

### What are the top 10 leading causes of death in NYC?

```{r plot 1, echo = FALSE, error = TRUE, message = FALSE}
nyc_df_1 = read_csv(file = "./data/nyc_clean.csv")

nyc_df_1 %>%
  group_by(leading_cause) %>%
  summarize(total_death = sum(deaths, na.rm = TRUE)) %>%
  arrange(desc(total_death)) %>%
  head(10) %>%
  mutate(leading_cause = fct_reorder(leading_cause, total_death)) %>% 
  ggplot(aes(x = leading_cause, y = total_death, fill = leading_cause)) +
  geom_col() +
  labs(title = "Top 10 Leading Causes of Death in NYC", 
    x = "Cause of Death", 
    y = "Number of Deaths") +
  theme(legend.position = "none") +
  coord_flip() 
  
```



```{r, echo = FALSE, message = FALSE}
# Death rate change for US

us_df = read_csv(file = "./data/Leading_Causes_of_Death_US_Only.csv", col_types = "ffffid") %>%
  filter(cause_name != "All causes") 

us_deaths = us_df %>%
  group_by(x113_cause_name) %>%
  summarize(Counts = sum(deaths)) %>% 
  arrange(Counts) %>% 
  tail(3)
  
# Top 3 leading causes of death for US from 1999 to 2017 are: 
# "Diseases of heart"
# "Malignant neoplasms"
# "Cerebrovascular diseases"
```

## **Changes in the Leading Cause of Death**

### How has the death rate of top 3 leading causes changed over the years in the US?
```{r us plot 2, echo = FALSE, error = TRUE, message = FALSE, warning = FALSE}
US_df_1_plot_1 = 
  US_df_1 %>% 
  filter(x113_cause_name == c("Diseases of heart", "Malignant neoplasms", "Cerebrovascular diseases")) %>% 
  group_by(year, x113_cause_name) %>%  
  summarize(total_death = sum(deaths)) %>%
  arrange(desc(total_death)) %>%
  mutate(x113_cause_name = fct_reorder(x113_cause_name, total_death)) %>% 
  ggplot(aes(x = year, y = total_death, color = x113_cause_name)) + 
  geom_line(size = 1) + 
  labs(title = 'Top 3 Leading Causes of Death (2000-2015)', x = 'Year', y = 'Death Count') + 
  transition_reveal(year)

US_df_1_plot_1
```

### How has the death rate of top 3 leading causes changed over the years in NYC?

```{r plot 2, echo = FALSE, error = TRUE, message = FALSE}
nyc_change = 
  nyc_df %>%
  filter(leading_cause %in% c("Malignant Neoplasms", "All Other Causes", "Diseases of Heart")) %>%
  mutate(deaths = as.numeric(deaths)) %>%
  group_by(year, leading_cause) %>%  
  summarize(total_death = sum(deaths)) %>%
  ggplot(aes(x= year, y = total_death, color = leading_cause)) + 
  geom_line(size=1) + 
  labs(title='Top 3 leading causes of death (2007-2014)', x='Year', y='Death count')+ 
  theme(legend.text= element_text(size =8))+ 
  transition_reveal(year)

nyc_change
```


## **Racial and Sex Differences in U.S. Mortality**

### How have the top 3 leading causes of death changed for each race in NYC?


```{r plot 3, echo = FALSE, error = TRUE, message = FALSE}

nyc_df %>%
  filter(leading_cause %in% c("Malignant Neoplasms", "All Other Causes", "Diseases of Heart")) %>%
  mutate(deaths = as.numeric(deaths)) %>%
  group_by(year, leading_cause, race_ethnicity) %>%  
  summarize(total_death = sum(deaths)) %>%
  ggplot(aes(x= year, y = total_death, color = leading_cause)) + 
  geom_line(size=1) + 
  labs(title='Top 3 leading causes of death by ethnicity (2007-2014)', x='Year', y='Death count') +
  facet_wrap(~race_ethnicity, ncol=3, scales = 'free_y')

```

### Are there differences in the leading causes of death between men and women in NYC?

```{r plot 4, echo = FALSE, error = TRUE, message = FALSE}

nyc_df %>%
  filter(leading_cause %in% c("Accidents Except Drug Posioning",
                              "Diabetes Mellitus", 
                              "Human Immunodeficiency Virus Disease", 
                              "Cerebrovascular Disease")) %>% 
  group_by(leading_cause, sex) %>% 
  count() %>%
  ggplot(aes(x = sex, y = n, fill = sex)) +
  geom_col() +
  labs(title='Gender differences in leading causes of death', x='Sex', y= 'Death count') +
  facet_wrap(~leading_cause)

```

## **Statistical Analyses**

### Is there a statistically significant difference in death rates between men and women in New York City?


```{r t test, echo = FALSE, error = TRUE, message = FALSE, warning = FALSE, comment = ""}

t_test_df = nyc_df %>%
  select(death_rate, sex) %>%
  mutate(
    death_rate = as.numeric(death_rate),
    sex = factor(sex)
  )

t.test(death_rate ~ sex, data = t_test_df)

```

p-value = 0.479 > 0.05

At 0.05 significance level, we fail to reject the null hypothesis and conclude that true mean difference in death rates between men and women is 0. Hence, we can state that there isn't any significant difference in the death rates between men and women in New York. 
        
            
### Is there a statistically significant difference in death rates across different ethnicities in New York City?    
       
         
```{r anova, echo = FALSE, error = TRUE, message = FALSE, warning = FALSE}
anova_df = nyc_df %>%
  select(death_rate, race_ethnicity) %>%
  mutate(
    death_rate = as.numeric(death_rate),
    race_ethnicity = recode(
      race_ethnicity, 
      "White Non-Hispanic" = "White",
      "Black Non-Hispanic" = "Black",
      "Other Race/ Ethnicity" = "Other",
      "Asian and Pacific Islander" = "Asian/PI",
      "Not Stated/Unknown" = "Unknown"
      ),
    race_ethnicity = factor(race_ethnicity)
  )

anova_test(death_rate ~ race_ethnicity, data = anova_df) %>% kable()
```
        
          
p-value = 1.83e-14 < 0.05

At 0.05 significance level, we reject the null hypothesis and conclude that there is a significant difference in death rates across different ethnicities, in New York City.



```{r, echo = FALSE, message = FALSE, error = TRUE}


# find top 10 leading causes for each state each year from 1999 - 2017
states_df = read_csv(file = "./data/Leading_Causes_of_Death_States_Only.csv", col_types = "ffffid") %>%
  filter(cause_name != "All Causes") %>%
  arrange(year, state, age_adjusted_death_rate) %>%
  slice(which(row_number() %% 10 == 0))

# mode function
mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

states_summary =   
  states_df %>% group_by(year) %>% 
  summarize(Mode = mode(cause_name))

```




```{r us plot 3, echo = FALSE, error = TRUE, message = FALSE, warning = FALSE}
#US_df_1_plot_2 = 
#  US_df_1 %>% 
#  filter(x113_cause_name == c("Diseases of heart", "Malignant neoplasms", "Cerebrovascular diseases")) %>% 
#  group_by(x113_cause_name, state) %>%  
#  summarize(total_death = sum(deaths)) %>%
#  arrange(desc(total_death)) %>%
#  ggplot(aes(x = state, y = total_death, color = x113_cause_name)) + 
#  geom_line(size = 1) + 
#  facet_wrap(~x113_cause_name, ncol=3, scales = 'free_y') +
#  labs(title = 'Top 3 Leading Causes of Death by States', x = 'State', y = 'Death Count') 

```

